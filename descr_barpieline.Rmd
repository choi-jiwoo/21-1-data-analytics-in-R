---
title: "descr_barpieline"
author: "이서희"
date: "4/25/2021"
output: html_document
---
```{r}
library(dplyr)
library(ggplot2)
library(RColorBrewer)
library(reshape2)
library(data.table) # setdt() 사용하기 위해
library(plyr) #desc()를 사용하기 위해서 필요하다.
```


```{r}
# 코로나 전후 청원데이터 불러오기
total<- rbind(before, after)

before_cat <- before[grep("자영업|소상공인", before$title),]
after_cat <- after[grep("자영업|소상공인", after$title),]

```

```{r}
# category 확인
sort(unique(before_cat$category))
sort(unique(after_cat$category))
length(unique(before_cat$category))
length(unique(after_cat$category))
```
코로나 전 해당 키워드에 대해 청원이 올라온 카테고리의 수는 16, 코로나 후에는 14임을 알수 있다. 

```{r}
# 간단한 데이터 확인
str(before_cat)
str(after_cat)
```
코로나 전의 자영업에 대한 청원 건수가 더 많다. 

```{r}
# 카테고리별 청원건수 빈도와 비율 확인후 데이터프레임 생성
before_df<- cbind(freq= table(before_cat$category), relative= prop.table(table(before_cat$category)))
before_df<- as.data.frame(before_df)

after_df<- cbind(freq= table(after_cat$category), relative= prop.table(table(after_cat$category)))
after_df<- as.data.frame(after_df)

# 비율로 정렬
before_df<- before_df[c(order(-rank(before_df$relative))),]
before_df
after_df<- after_df[c(order(-rank(after_df$relative))),]
after_df
```
코로나 전에는 일자리 카테고리에 자영업과 관련한 글들이 많이 올라왔는데 코로나 후에는 행정 카테고리에 관련 글이 많이 올라왔음을 볼 수 있다. 

```{r}
## rownames가 카테고리로 되어있어 카테고리를 열 변수로 빼고 새로운 행이름을 설정
setDT(before_df, keep.rownames = TRUE)[]
## 변수명이 rn으로 빼진 카테고리 변수명을 category로 재설정
before_df<- rename(before_df, c(rn="category"))
## df에 period 변수 생성
before_df<- before_df %>%
  mutate(period="before")

after_df<- data.frame(after_df)
setDT(after_df, keep.rownames = TRUE)[]
after_df<- rename(after_df, c(rn="category"))
after_df<- after_df %>%
  mutate(period="after")
```

```{r}
# 카테고리별 청원동의 인원수 변수 생성 후 before_df, after_df통합
temp= data.frame()

temp<- before %>%
  group_by(category) %>%
  dplyr::summarize(AgreeSum= sum(numOfAgrees))
before_df<- merge(before_df, temp, by='category')

temp2<- after %>%
  group_by(category) %>%
  dplyr::summarize(AgreeSum= sum(numOfAgrees))
after_df<- merge(after_df, temp2, by='category')

total_df<- rbind(after_df,before_df)
total_df
```

# 막대그래프

```{r}
# 막대 그래프
# 빈도 건수
ggplot(total_df, aes(x= category, y= freq, fill=period))+
  geom_bar(stat="identity",position= position_dodge2(reverse = TRUE))+
  scale_fill_brewer(palette="Set2")+
  labs(title="코로나 전후 자영업 소상공인 키워드에 대한 \n카테고리 별 청원 건수")+
  theme_bw()+
  theme(plot.title = element_text(hjust = 0.5, face='bold', size = 15))+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5 ))+
  theme(legend.text = element_text(size = 8))+
  guides(fill=guide_legend(reverse=TRUE))

```
건수 그래프는 삭제해도 괜찮아요.
```{r}
# 비율
ggplot(total_df, aes(x= category, y= relative, fill=period))+
  geom_bar(stat="identity",position= position_dodge2(reverse = TRUE))+
  scale_fill_brewer(palette="Set2")+
  labs(title="코로나 전후 자영업 소상공인 키워드에 대한 \n카테고리 별 청원 비율")+
  theme_bw()+
  theme(plot.title = element_text(hjust = 0.5, face='bold', size = 15))+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5 ))+
  theme(legend.text = element_text(size = 8))+
  guides(fill=guide_legend(reverse=TRUE))

```
코로나 전후 자영업 키워드에 대해 일자리와 보건복지, 행정 카테고리에 확연한 차이가 있음을 볼 수 있다. 

# 파이그래프

```{r}
# 파이 그래프
par(mfrow=c(2,1))
ggplot(before_df, aes(x="", y= -freq, fill= reorder(category,-freq)))+
  geom_bar(stat="identity")+
  coord_polar("y")+
  theme_void()+
  labs(title="코로나 전 자영업 소상공인 키워드에 대한 \n카테고리 별 청원 건수")+
  theme(plot.title = element_text(hjust = 0.6, face='bold', size = 15))

ggplot(after_df, aes(x="", y= -freq, fill= reorder(category,-freq)))+
  geom_bar(stat="identity")+
  coord_polar("y")+
  theme_void()+
  labs(title="코로나 후 자영업 소상공인 키워드에 대한 \n카테고리 별 청원 건수")+
  theme(plot.title = element_text(hjust = 0.6, face='bold', size = 15))
```

# 라인그래프

```{r}
# 시간에 따른 자영업 청원건수, 청원동의 인원수, 청원건수 대비 청원동의 인원수를 보여주는 그래프 작성
petit_count<- total_cat %>%
  group_by(expiryDate) %>%
  tally() 

petit_ratio<- total_cat %>%
  group_by(expiryDate) %>%
  dplyr::summarize(agreeSum= sum(numOfAgrees))

petit_rat_cnt<- merge(petit_ratio, petit_count, by="expiryDate") 
petit_rat_cnt$ratCnt<- petit_rat_cnt$agreeSum / petit_rat_cnt$n  

petit_rat_cnt
```

```{r}
a= ggplot(petit_rat_cnt, aes(expiryDate, n))+
  geom_line()+
  theme_classic()+
  labs(title="자영업 소상공인에 대한  청원 건수 변화")+
  theme(plot.title = element_text(hjust = 0.6, face='bold', size = 15))+
  geom_vline(xintercept = as.numeric(petit_rat_cnt$expiryDate[112]),color =  "red", linetype = 2)

b= ggplot(petit_rat_cnt, aes(expiryDate, agreeSum))+
  geom_line()+
  theme_classic()+
  labs(title="자영업 소상공인에 대한  청원동의 인원수의 변화")+
  theme(plot.title = element_text(hjust = 0.6, face='bold', size = 15))+
  geom_vline(xintercept = as.numeric(petit_rat_cnt$expiryDate[112]),color =  "red", linetype = 2)

c= ggplot(petit_rat_cnt, aes(expiryDate, ratCnt))+
  geom_line()+
  theme_classic()+
  labs(title="자영업 소상공인에 대한  청원 건수 대비 청원동의 인원수의 변화")+
  theme(plot.title = element_text(hjust = 0.6, face='bold', size = 15))+
  geom_vline(xintercept = as.numeric(petit_rat_cnt$expiryDate[112]),color =  "red", linetype = 2)

grid.arrange(a,b,c, nrow=3, ncol=1)

```

코로나 첫 확진자 발생일 2020년 1/19 이후 처음으로 자영업 청원이 업로드된 2020년 1월 22일을 경계로 설정하였다. before 데이터에 건수가 많기 때문에 청원건수만 보았을 땐 코로나 이전에 더 많이 접수된 것으로 보이지만, 청원동의 인원수와 청원건수 대비 청원동의 인원수의 변화를 보면 코로나 후에 자영업 청원에 대한 국민적 공감대가 높아졌음을 확인할 수 있다. 